# CiteBite Parallel Processing Pipeline

ì´ ë¬¸ì„œëŠ” Collection ìƒì„± ì‹œ ì‘ë™í•˜ëŠ” ë³‘ë ¬ ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸ì˜ ì•„í‚¤í…ì²˜ì™€ ë™ì‘ ë°©ì‹ì„ ìƒì„¸íˆ ì„¤ëª…í•©ë‹ˆë‹¤.

---

## ëª©ì°¨

1. [ì‹œìŠ¤í…œ ê°œìš”](#1-ì‹œìŠ¤í…œ-ê°œìš”)
2. [í ì•„í‚¤í…ì²˜](#2-í-ì•„í‚¤í…ì²˜)
3. [íŒŒì´í”„ë¼ì¸ í”Œë¡œìš°](#3-íŒŒì´í”„ë¼ì¸-í”Œë¡œìš°)
4. [ì›Œì»¤ ìƒì„¸ êµ¬í˜„](#4-ì›Œì»¤-ìƒì„¸-êµ¬í˜„)
5. [ë³‘ë ¬í™” ì „ëµ](#5-ë³‘ë ¬í™”-ì „ëµ)
6. [ìƒíƒœ ì¶”ì  ì‹œìŠ¤í…œ](#6-ìƒíƒœ-ì¶”ì -ì‹œìŠ¤í…œ)
7. [ì—ëŸ¬ ì²˜ë¦¬ ë° ì¬ì‹œë„](#7-ì—ëŸ¬-ì²˜ë¦¬-ë°-ì¬ì‹œë„)
8. [ì„¤ì • íŒŒë¼ë¯¸í„°](#8-ì„¤ì •-íŒŒë¼ë¯¸í„°)
9. [ëª¨ë‹ˆí„°ë§ ë° ë””ë²„ê¹…](#9-ëª¨ë‹ˆí„°ë§-ë°-ë””ë²„ê¹…)

---

## 1. ì‹œìŠ¤í…œ ê°œìš”

CiteBiteëŠ” BullMQ(Redis ê¸°ë°˜ ì‘ì—… í)ë¥¼ ì‚¬ìš©í•˜ì—¬ PDF ì²˜ë¦¬ë¥¼ ë¹„ë™ê¸°ì ìœ¼ë¡œ ìˆ˜í–‰í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´:

- **ì‚¬ìš©ì ëŒ€ê¸° ì‹œê°„ ìµœì†Œí™”**: Collection ìƒì„± ì¦‰ì‹œ ì‘ë‹µ, ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì²˜ë¦¬
- **ë†’ì€ ì²˜ë¦¬ëŸ‰**: ë™ì‹œì— 50ê°œ ì´ìƒì˜ ë…¼ë¬¸ ì²˜ë¦¬ ê°€ëŠ¥
- **ì¥ì•  ë³µêµ¬**: ê°œë³„ ì‘ì—… ì‹¤íŒ¨ ì‹œ ìë™ ì¬ì‹œë„
- **ë…ë¦½ì  ì§„í–‰**: í…ìŠ¤íŠ¸ ì¸ë±ì‹±ê³¼ ì´ë¯¸ì§€ ë¶„ì„ì´ ë…ë¦½ì ìœ¼ë¡œ ì§„í–‰

### ì „ì²´ ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ì‚¬ìš©ì ìš”ì²­                                      â”‚
â”‚                         (Collection ìƒì„±)                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Next.js API Route                                  â”‚
â”‚                       POST /api/collections                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. Zod ìŠ¤í‚¤ë§ˆ ê²€ì¦                                                    â”‚   â”‚
â”‚  â”‚ 2. Semantic Scholar APIë¡œ ë…¼ë¬¸ ë©”íƒ€ë°ì´í„° ì¡°íšŒ (ë³‘ë ¬)                   â”‚   â”‚
â”‚  â”‚ 3. DBì— Collection + Papers ì €ì¥                                      â”‚   â”‚
â”‚  â”‚ 4. Open Access ë…¼ë¬¸ì— ëŒ€í•´ PDF Download Job íì‰                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼ (ì¦‰ì‹œ ì‘ë‹µ ë°˜í™˜)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              Redis í                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ pdf-download â”‚  â”‚ pdf-indexing â”‚  â”‚figure-analysisâ”‚  â”‚bulk-cleanup â”‚   â”‚
â”‚  â”‚   (5 ë™ì‹œ)   â”‚  â”‚   (3 ë™ì‹œ)   â”‚  â”‚   (5 ë™ì‹œ)    â”‚  â”‚  (1 ë™ì‹œ)   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            BullMQ Workers                                    â”‚
â”‚                          (npm run workers)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. í ì•„í‚¤í…ì²˜

### 2.1 í ì •ì˜ (`src/lib/jobs/queues.ts`)

| í ì´ë¦„               | ëª©ì                               | ë™ì‹œ ì²˜ë¦¬ ìˆ˜ | ì¬ì‹œë„ | ì´ˆê¸° ëŒ€ê¸°ì‹œê°„ |
| --------------------- | --------------------------------- | ------------ | ------ | ------------- |
| `pdf-download`        | Semantic Scholarì—ì„œ PDF ë‹¤ìš´ë¡œë“œ | 5            | 3íšŒ    | 2ì´ˆ           |
| `pdf-indexing`        | í…ìŠ¤íŠ¸ ì¶”ì¶œ, ì²­í‚¹, ì„ë² ë”© ìƒì„±    | 3            | 3íšŒ    | 5ì´ˆ           |
| `figure-analysis`     | Figure ì¶”ì¶œ ë° AI ë¶„ì„            | 5            | 3íšŒ    | 5ì´ˆ           |
| `bulk-upload-cleanup` | ë§Œë£Œëœ ì„ì‹œ ì—…ë¡œë“œ ì •ë¦¬           | 1            | 3íšŒ    | 5ì´ˆ           |

### 2.2 Job ë°ì´í„° íƒ€ì…

```typescript
// PDF ë‹¤ìš´ë¡œë“œ ì‘ì—…
interface PdfDownloadJobData {
  collectionId: string; // Collection UUID
  paperId: string; // Semantic Scholar Paper ID
  pdfUrl: string; // PDF ë‹¤ìš´ë¡œë“œ URL
}

// PDF ì¸ë±ì‹± ì‘ì—…
interface PdfIndexJobData {
  collectionId: string;
  paperId: string;
  storageKey: string; // Supabase Storage ê²½ë¡œ
}

// Figure ë¶„ì„ ì‘ì—…
interface FigureAnalysisJobData {
  collectionId: string;
  paperId: string;
  storageKey: string;
}

// ì¼ê´„ ì—…ë¡œë“œ ì •ë¦¬ ì‘ì—…
interface BulkUploadCleanupJobData {
  sessionId?: string;
  userId?: string;
}
```

### 2.3 í ì„¤ì • ìƒì„¸

```typescript
// ëª¨ë“  í ê³µí†µ ì„¤ì •
const defaultJobOptions = {
  attempts: 3,
  backoff: {
    type: 'exponential',
    delay: 2000 // pdf-download: 2ì´ˆ, ë‚˜ë¨¸ì§€: 5ì´ˆ
  },
  removeOnComplete: {
    age: 86400,   // ì™„ë£Œ í›„ 24ì‹œê°„ ë³´ê´€
    count: 1000   // ìµœëŒ€ 1000ê°œ ë³´ê´€
  },
  removeOnFail: {
    age: 604800   // ì‹¤íŒ¨ ì‹œ 7ì¼ ë³´ê´€
  },
};

// Rate Limiting (ëª¨ë“  í)
limiter: {
  max: 10,        // ì´ˆë‹¹ ìµœëŒ€ 10ê°œ
  duration: 1000  // 1000ms ê¸°ì¤€
}
```

---

## 3. íŒŒì´í”„ë¼ì¸ í”Œë¡œìš°

### 3.1 Collection ìƒì„± íŒŒì´í”„ë¼ì¸

```
ì‚¬ìš©ì: "quantum computing" ì£¼ì œë¡œ Collection ìƒì„± ìš”ì²­
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/collections                                          â”‚
â”‚  â”œâ”€ 1. ì…ë ¥ ê²€ì¦ (Zod)                                          â”‚
â”‚  â”œâ”€ 2. ì‚¬ìš©ì ì¸ì¦ í™•ì¸                                          â”‚
â”‚  â”œâ”€ 3. Semantic Scholar Batch APIë¡œ ë…¼ë¬¸ ì¡°íšŒ (ë³‘ë ¬)            â”‚
â”‚  â”œâ”€ 4. Collection ë ˆì½”ë“œ ìƒì„±                                    â”‚
â”‚  â”œâ”€ 5. Papers í…Œì´ë¸”ì— upsert (ì¤‘ë³µ ë°©ì§€)                        â”‚
â”‚  â”œâ”€ 6. collection_papers ì—°ê²° í…Œì´ë¸” ìƒì„±                        â”‚
â”‚  â”œâ”€ 7. Open Access ë…¼ë¬¸ í•„í„°ë§                                   â”‚
â”‚  â””â”€ 8. pdf-download íì— Job ì¶”ê°€                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
        { collectionId, totalPapers, openAccessCount, queuedDownloads }
                    â”‚
                    â–¼ (ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë¹„ë™ê¸° ì²˜ë¦¬ ì‹œì‘)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  pdf-download Queue (5ê°œ ë™ì‹œ ì²˜ë¦¬)                              â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Paper 1 â”‚ â”‚ Paper 2 â”‚ â”‚ Paper 3 â”‚ â”‚ Paper 4 â”‚ â”‚ Paper 5 â”‚  â”‚
â”‚  â”‚Download â”‚ â”‚Download â”‚ â”‚Download â”‚ â”‚Download â”‚ â”‚Download â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â”‚
â”‚       â”‚           â”‚           â”‚           â”‚           â”‚        â”‚
â”‚       â–¼           â–¼           â–¼           â–¼           â–¼        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              ìë™ìœ¼ë¡œ pdf-indexing Job íì‰               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  pdf-indexing Queue (3ê°œ ë™ì‹œ ì²˜ë¦¬)                              â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚  â”‚ Paper 1 â”‚ â”‚ Paper 2 â”‚ â”‚ Paper 3 â”‚  ... (ëŒ€ê¸° ì¤‘)            â”‚
â”‚  â”‚ Index   â”‚ â”‚ Index   â”‚ â”‚ Index   â”‚                           â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                           â”‚
â”‚       â”‚           â”‚           â”‚                                 â”‚
â”‚       â–¼           â–¼           â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚            ìë™ìœ¼ë¡œ figure-analysis Job íì‰              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  figure-analysis Queue (5ê°œ ë™ì‹œ ì²˜ë¦¬)                           â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Paper 1 â”‚ â”‚ Paper 2 â”‚ â”‚ Paper 3 â”‚ â”‚ Paper 4 â”‚ â”‚ Paper 5 â”‚  â”‚
â”‚  â”‚ Figures â”‚ â”‚ Figures â”‚ â”‚ Figures â”‚ â”‚ Figures â”‚ â”‚ Figures â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
              RAG ì±„íŒ… ê°€ëŠ¥!
```

### 3.2 ìë™ Job ì²´ì´ë‹

ê° ì›Œì»¤ëŠ” ì‘ì—… ì™„ë£Œ ì‹œ ë‹¤ìŒ ì›Œì»¤ì˜ Jobì„ ìë™ìœ¼ë¡œ íì‰í•©ë‹ˆë‹¤:

```typescript
// pdf-download worker ì™„ë£Œ ì‹œ
await pdfIndexQueue.add('index', {
  collectionId: job.data.collectionId,
  paperId: job.data.paperId,
  storageKey: storagePath, // ë‹¤ìš´ë¡œë“œëœ PDF ê²½ë¡œ ì „ë‹¬
});

// pdf-indexing worker ì™„ë£Œ ì‹œ
await figureAnalysisQueue.add('analyze', {
  collectionId: job.data.collectionId,
  paperId: job.data.paperId,
  storageKey: job.data.storageKey, // ë™ì¼í•œ PDF ê²½ë¡œ
});
```

### 3.3 ëŒ€ì•ˆ ê²½ë¡œ: ìˆ˜ë™ ì—…ë¡œë“œ

Open Accessê°€ ì•„ë‹Œ ë…¼ë¬¸ì´ë‚˜ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ ì‹œ ìˆ˜ë™ ì—…ë¡œë“œ ê²½ë¡œ:

```
ì‚¬ìš©ì: PDF íŒŒì¼ ì§ì ‘ ì—…ë¡œë“œ
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/papers/[paperId]/upload                              â”‚
â”‚  â”œâ”€ PDF ê²€ì¦ (íƒ€ì…, í¬ê¸°)                                        â”‚
â”‚  â”œâ”€ Supabase Storageì— ì—…ë¡œë“œ                                    â”‚
â”‚  â”œâ”€ ë…¼ë¬¸ ìƒíƒœ ì—…ë°ì´íŠ¸ (pdf_source: 'manual')                    â”‚
â”‚  â””â”€ pdf-indexing íì— ì§ì ‘ Job ì¶”ê°€ (ë‹¤ìš´ë¡œë“œ ê±´ë„ˆëœ€)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
    pdf-indexing â†’ figure-analysis (ë™ì¼ íŒŒì´í”„ë¼ì¸)
```

---

## 4. ì›Œì»¤ ìƒì„¸ êµ¬í˜„

### 4.1 PDF Download Worker

**íŒŒì¼**: `src/lib/jobs/workers/pdfDownloadWorker.ts`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PDF Download Worker                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ì…ë ¥: { collectionId, paperId, pdfUrl }                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. PDF ë‹¤ìš´ë¡œë“œ                                                â”‚
â”‚     â”œâ”€ User-Agent: Chrome ë¸Œë¼ìš°ì € ìœ„ì¥                         â”‚
â”‚     â”œâ”€ Referer: arxiv.org, semanticscholar.org ì„¤ì •            â”‚
â”‚     â”œâ”€ Timeout: 30ì´ˆ                                           â”‚
â”‚     â””â”€ Max Size: 100MB                                         â”‚
â”‚                        â”‚                                        â”‚
â”‚                        â–¼                                        â”‚
â”‚  2. Content-Type ê²€ì¦                                           â”‚
â”‚     â””â”€ application/pdf í™•ì¸                                    â”‚
â”‚                        â”‚                                        â”‚
â”‚                        â–¼                                        â”‚
â”‚  3. Supabase Storage ì—…ë¡œë“œ                                     â”‚
â”‚     â””â”€ ê²½ë¡œ: /pdfs/{collectionId}/{paperId}.pdf                â”‚
â”‚                        â”‚                                        â”‚
â”‚                        â–¼                                        â”‚
â”‚  4. DB ìƒíƒœ ì—…ë°ì´íŠ¸                                            â”‚
â”‚     â””â”€ text_vector_status: 'processing'                        â”‚
â”‚                        â”‚                                        â”‚
â”‚                        â–¼                                        â”‚
â”‚  5. pdf-indexing Job íì‰ (ìë™ ì²´ì´ë‹)                         â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ì¶œë ¥: { paperId, storagePath }                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**í•µì‹¬ ì½”ë“œ**:

```typescript
// ë¸Œë¼ìš°ì € ìœ„ì¥ í—¤ë”
const headers = {
  'User-Agent':
    'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36...',
  Accept: 'application/pdf,*/*',
  Referer: pdfUrl.includes('arxiv')
    ? 'https://arxiv.org/'
    : 'https://www.semanticscholar.org/',
};

// ë‹¤ìš´ë¡œë“œ ë° ê²€ì¦
const response = await axios.get(pdfUrl, {
  responseType: 'arraybuffer',
  headers,
  timeout: 30000,
  maxContentLength: 100 * 1024 * 1024,
});
```

### 4.2 PDF Indexing Worker

**íŒŒì¼**: `src/lib/jobs/workers/pdfIndexWorker.ts`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PDF Indexing Worker                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ì…ë ¥: { collectionId, paperId, storageKey }                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. Supabase Storageì—ì„œ PDF ë‹¤ìš´ë¡œë“œ                           â”‚
â”‚                        â”‚                                        â”‚
â”‚                        â–¼                                        â”‚
â”‚  2. í…ìŠ¤íŠ¸ ì¶”ì¶œ (pdf-parse)                                     â”‚
â”‚     â””â”€ ìµœì†Œ 100ì ê²€ì¦                                         â”‚
â”‚                        â”‚                                        â”‚
â”‚                        â–¼                                        â”‚
â”‚  3. í…ìŠ¤íŠ¸ ì²­í‚¹ + Figure ì°¸ì¡° ì¶”ì¶œ                              â”‚
â”‚     â”œâ”€ Max chunk: 3072ì (â‰ˆ768 tokens)                         â”‚
â”‚     â”œâ”€ Overlap: 450ì                                          â”‚
â”‚     â””â”€ referenced_figures: ["Figure 1", "Table 2", ...]        â”‚
â”‚                        â”‚                                        â”‚
â”‚                        â–¼                                        â”‚
â”‚  4. ì„ë² ë”© ìƒì„± (Gemini embedding-001)                          â”‚
â”‚     â”œâ”€ ë°°ì¹˜ í¬ê¸°: 100 chunks/ìš”ì²­                              â”‚
â”‚     â””â”€ ì°¨ì›: 768                                               â”‚
â”‚                        â”‚                                        â”‚
â”‚                        â–¼                                        â”‚
â”‚  5. ê¸°ì¡´ chunks ì‚­ì œ (ì¬ì¸ë±ì‹± ì§€ì›)                            â”‚
â”‚                        â”‚                                        â”‚
â”‚                        â–¼                                        â”‚
â”‚  6. paper_chunks í…Œì´ë¸”ì— ì‚½ì…                                  â”‚
â”‚     â””â”€ chunk_type: 'text'                                      â”‚
â”‚                        â”‚                                        â”‚
â”‚                        â–¼                                        â”‚
â”‚  7. DB ìƒíƒœ ì—…ë°ì´íŠ¸                                            â”‚
â”‚     â””â”€ text_vector_status: 'completed'                         â”‚
â”‚                        â”‚                                        â”‚
â”‚                        â–¼                                        â”‚
â”‚  8. figure-analysis Job íì‰ (ìë™ ì²´ì´ë‹)                      â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ì¶œë ¥: { paperId, chunksCreated, pagesProcessed, totalTokens } â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Figure ì°¸ì¡° ì¶”ì¶œ**:

```typescript
// ì²­í‚¹ ì‹œ ê° chunkì—ì„œ Figure/Table ì°¸ì¡° ì¶”ì¶œ
const figurePattern = /(?:Figure|Fig\.|Table|Chart|Diagram)\s*\d+/gi;
const referencedFigures = chunk.match(figurePattern) || [];
```

**ì§„í–‰ë¥  ì—…ë°ì´íŠ¸**:

```typescript
// í”„ë¡ íŠ¸ì—”ë“œ progress barë¥¼ ìœ„í•œ ì—…ë°ì´íŠ¸
await job.updateProgress(5); // PDF ë‹¤ìš´ë¡œë“œ ì‹œì‘
await job.updateProgress(10); // í…ìŠ¤íŠ¸ ì¶”ì¶œ ì™„ë£Œ
await job.updateProgress(15); // ì²­í‚¹ ì‹œì‘
await job.updateProgress(25); // ì²­í‚¹ ì™„ë£Œ
await job.updateProgress(30); // ì„ë² ë”© ì‹œì‘
// ... ì„ë² ë”© ì§„í–‰ ì¤‘ 30-90% ...
await job.updateProgress(90); // ì„ë² ë”© ì™„ë£Œ
await job.updateProgress(100); // DB ì €ì¥ ì™„ë£Œ
```

### 4.3 Figure Analysis Worker

**íŒŒì¼**: `src/lib/jobs/workers/figureAnalysisWorker.ts`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Figure Analysis Worker                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ì…ë ¥: { collectionId, paperId, storageKey }                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. DB ìƒíƒœ ì—…ë°ì´íŠ¸                                            â”‚
â”‚     â””â”€ image_vector_status: 'processing'                       â”‚
â”‚                        â”‚                                        â”‚
â”‚                        â–¼                                        â”‚
â”‚  2. Supabase Storageì—ì„œ PDF ë‹¤ìš´ë¡œë“œ                           â”‚
â”‚                        â”‚                                        â”‚
â”‚                        â–¼                                        â”‚
â”‚  3. PDF í˜ì´ì§€ â†’ ì´ë¯¸ì§€ ë Œë”ë§                                  â”‚
â”‚     â””â”€ DPI: 150 (í’ˆì§ˆ/ì„±ëŠ¥ ê· í˜•)                               â”‚
â”‚                        â”‚                                        â”‚
â”‚                        â–¼                                        â”‚
â”‚  4. pdffigures2ë¡œ Figure ê°ì§€                                   â”‚
â”‚     â”œâ”€ í˜ì´ì§€ ë ˆì´ì•„ì›ƒ ë¶„ì„                                     â”‚
â”‚     â””â”€ Bounding box ì¶”ì¶œ                                       â”‚
â”‚                        â”‚                                        â”‚
â”‚                        â”œâ”€â”€â”€ Figure ì—†ìŒ â”€â”€â”€â–¶ status: 'skipped' â”‚
â”‚                        â”‚                                        â”‚
â”‚                        â–¼                                        â”‚
â”‚  5. Figure ì´ë¯¸ì§€ ì¶”ì¶œ (í¬ë¡­)                                   â”‚
â”‚                        â”‚                                        â”‚
â”‚                        â–¼                                        â”‚
â”‚  6. í…ìŠ¤íŠ¸ ì²­í¬ì—ì„œ Figure ì°¸ì¡° ì¡°íšŒ                            â”‚
â”‚     â””â”€ buildTextContextMap()                                   â”‚
â”‚     â””â”€ Map<figureNumber, TextChunk[]>                          â”‚
â”‚                        â”‚                                        â”‚
â”‚                        â–¼                                        â”‚
â”‚  7. Gemini Vision APIë¡œ Figure ë¶„ì„                            â”‚
â”‚     â”œâ”€ ë°°ì¹˜ í¬ê¸°: 10 figures                                   â”‚
â”‚     â”œâ”€ ë°°ì¹˜ ê°„ ë”œë ˆì´: 200ms                                    â”‚
â”‚     â””â”€ í…ìŠ¤íŠ¸ ì»¨í…ìŠ¤íŠ¸ í•¨ê»˜ ì œê³µ                                â”‚
â”‚                        â”‚                                        â”‚
â”‚                        â–¼                                        â”‚
â”‚  8. paper_chunks í…Œì´ë¸”ì— Figure ì €ì¥                           â”‚
â”‚     â”œâ”€ chunk_type: 'figure'                                    â”‚
â”‚     â”œâ”€ figure_number, caption, description                     â”‚
â”‚     â”œâ”€ image_storage_path                                      â”‚
â”‚     â””â”€ mentioned_in_chunk_ids (ì–‘ë°©í–¥ ë§í¬)                    â”‚
â”‚                        â”‚                                        â”‚
â”‚                        â–¼                                        â”‚
â”‚  9. DB ìƒíƒœ ì—…ë°ì´íŠ¸                                            â”‚
â”‚     â””â”€ image_vector_status: 'completed'                        â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ì¶œë ¥: { paperId, figuresIndexed, status }                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ì»¨í…ìŠ¤íŠ¸ í†µí•©**:

```typescript
// Figureê°€ ì–¸ê¸‰ëœ í…ìŠ¤íŠ¸ ì²­í¬ ì¡°íšŒ
const contextMap = await buildTextContextMap(paperId, collectionId);

// Vision API ë¶„ì„ ì‹œ ì»¨í…ìŠ¤íŠ¸ ì œê³µ
const analysis = await analyzeWithContext(figureImage, {
  figureNumber: 'Figure 3',
  relatedTextChunks: contextMap.get('Figure 3') || [],
});
```

### 4.4 Bulk Upload Cleanup Worker

**íŒŒì¼**: `src/lib/jobs/workers/bulkUploadCleanupWorker.ts`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Bulk Upload Cleanup Worker                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ì‹¤í–‰ ì£¼ê¸°: ë§¤ì‹œê°„ (cron: 0 * * * *)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. ë§Œë£Œëœ ì„¸ì…˜ ì¡°íšŒ                                            â”‚
â”‚     â””â”€ expires_at < NOW()                                      â”‚
â”‚     â””â”€ status IN ('uploading', 'reviewing', 'confirming')     â”‚
â”‚                        â”‚                                        â”‚
â”‚                        â–¼                                        â”‚
â”‚  2. ê° ì„¸ì…˜ì— ëŒ€í•´:                                             â”‚
â”‚     â”œâ”€ ì„ì‹œ íŒŒì¼ ì‚­ì œ (/bulk-temp/{userId}/{sessionId}/*)      â”‚
â”‚     â””â”€ ì„¸ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸ (status: 'expired')                  â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ë™ì‹œ ì²˜ë¦¬: 1 (ìˆœì°¨ ì²˜ë¦¬ë¡œ ì¼ê´€ì„± ë³´ì¥)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. ë³‘ë ¬í™” ì „ëµ

### 5.1 í ë ˆë²¨ ë³‘ë ¬í™”

ê° íëŠ” ë…ë¦½ì ìœ¼ë¡œ ì‘ì—…ì„ ë³‘ë ¬ ì²˜ë¦¬í•©ë‹ˆë‹¤:

```
                     ì‹œê°„ â†’

pdf-download  â•â•â•â•¤â•â•â•â•¤â•â•â•â•¤â•â•â•â•¤â•â•â•â•¤â•â•â•â•¤â•â•â•â•¤â•â•â•â•¤â•â•â•â•¤â•â•â•
(5 ë™ì‹œ)         â”‚P1 â”‚P2 â”‚P3 â”‚P4 â”‚P5 â”‚P6 â”‚P7 â”‚P8 â”‚P9 â”‚...
                 â•§â•â•â•â•§â•â•â•â•§â•â•â•â•§â•â•â•â•§â•â•â•â•§â•â•â•â•§â•â•â•â•§â•â•â•â•§â•â•â•

pdf-indexing  â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•
(3 ë™ì‹œ)             â”‚ P1    â”‚ P2    â”‚ P3    â”‚ P4   â”‚...
                     â•§â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•

figure-analysis â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•¤â•â•â•â•â•â•¤â•â•â•â•â•â•¤â•â•â•â•â•â•¤â•â•â•â•â•
(5 ë™ì‹œ)                 â”‚P1   â”‚P2   â”‚P3   â”‚P4   â”‚P5  â”‚...
                         â•§â•â•â•â•â•â•§â•â•â•â•â•â•§â•â•â•â•â•â•§â•â•â•â•â•â•§â•â•â•â•â•
```

### 5.2 Job ë‚´ë¶€ ë³‘ë ¬í™”

#### PDF Indexing - ì„ë² ë”© ë°°ì¹˜ ì²˜ë¦¬

```typescript
// 100ê°œ ì²­í¬ì”© ë°°ì¹˜ë¡œ ì„ë² ë”© ìƒì„±
const BATCH_SIZE = 100;
const batches = chunk(chunks, BATCH_SIZE);

for (const batch of batches) {
  // ê° ë°°ì¹˜ ë‚´ ëª¨ë“  ì²­í¬ì˜ ì„ë² ë”©ì„ í•œ ë²ˆì˜ API í˜¸ì¶œë¡œ ìƒì„±
  const embeddings = await generateEmbeddings(batch.map(c => c.content));

  // ì²­í¬ì™€ ì„ë² ë”© ë§¤í•‘
  batch.forEach((chunk, i) => {
    chunk.embedding = embeddings[i];
  });
}
```

#### Figure Analysis - ì´ë¯¸ì§€ ë°°ì¹˜ ë¶„ì„

```typescript
// 10ê°œ figureì”© ë³‘ë ¬ ë¶„ì„
const ANALYSIS_BATCH_SIZE = 10;
const RATE_LIMIT_DELAY = 200; // ms

const figureBatches = chunk(figures, ANALYSIS_BATCH_SIZE);

for (const batch of figureBatches) {
  // ë°°ì¹˜ ë‚´ ëª¨ë“  figureë¥¼ ë³‘ë ¬ë¡œ ë¶„ì„
  const analyses = await Promise.all(
    batch.map(fig => analyzeWithVisionAPI(fig))
  );

  // Rate limit ì¤€ìˆ˜ë¥¼ ìœ„í•œ ë°°ì¹˜ ê°„ ë”œë ˆì´
  await sleep(RATE_LIMIT_DELAY);
}
```

### 5.3 ë°ì´í„°ë² ì´ìŠ¤ ë ˆë²¨ ë³‘ë ¬í™”

```typescript
// ì²­í¬ ì¼ê´„ ì‚½ì… (upsertë¡œ ì¶©ëŒ ë°©ì§€)
await supabase.from('paper_chunks').upsert(chunksWithEmbeddings, {
  onConflict: 'paper_id,collection_id,chunk_index',
});
```

- ë½í‚¹ ì—†ìŒ: Upsertê°€ ì›ìì ìœ¼ë¡œ ì²˜ë¦¬
- ë™ì¼ Collectionì˜ ë‹¤ë¥¸ Paperë“¤ë„ ë™ì‹œ ì²˜ë¦¬ ê°€ëŠ¥

### 5.4 ë³‘ë ¬í™” ìš”ì•½

| ë ˆë²¨                  | ë³‘ë ¬í™” ë°©ì‹    | ë™ì‹œ ì²˜ë¦¬ëŸ‰     |
| --------------------- | -------------- | --------------- |
| í ê°„                 | ì™„ì „ ë…ë¦½ ì‹¤í–‰ | 4ê°œ í ë™ì‹œ     |
| pdf-download í ë‚´    | ë™ì‹œ ë‹¤ìš´ë¡œë“œ  | 5ê°œ             |
| pdf-indexing í ë‚´    | ë™ì‹œ ì¸ë±ì‹±    | 3ê°œ (API ì œí•œ)  |
| figure-analysis í ë‚´ | ë™ì‹œ ë¶„ì„      | 5ê°œ             |
| ì„ë² ë”© ìƒì„±           | ë°°ì¹˜ API í˜¸ì¶œ  | 100 chunks/ìš”ì²­ |
| Vision ë¶„ì„           | ë°°ì¹˜ ë³‘ë ¬ ë¶„ì„ | 10 figures/ë°°ì¹˜ |

---

## 6. ìƒíƒœ ì¶”ì  ì‹œìŠ¤í…œ

### 6.1 ì´ì¤‘ ìƒíƒœ í•„ë“œ

í…ìŠ¤íŠ¸ì™€ ì´ë¯¸ì§€ ì²˜ë¦¬ê°€ ë…ë¦½ì ì´ë¯€ë¡œ, ë‘ ê°œì˜ ë³„ë„ ìƒíƒœ í•„ë“œë¡œ ì¶”ì :

```sql
-- papers í…Œì´ë¸”
ALTER TABLE papers ADD COLUMN text_vector_status text DEFAULT 'pending';
ALTER TABLE papers ADD COLUMN image_vector_status text DEFAULT 'pending';
```

**text_vector_status ìƒíƒœ ì „ì´**:

```
pending â”€â”€â”€â”€â”€â–¶ processing â”€â”€â”€â”€â”€â–¶ completed
    â”‚               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â–¶ failed
```

**image_vector_status ìƒíƒœ ì „ì´**:

```
pending â”€â”€â”€â”€â”€â–¶ processing â”€â”€â”€â”€â”€â”¬â”€â–¶ completed
    â”‚               â”‚          â”‚
    â”‚               â”‚          â””â”€â–¶ skipped (Figure ì—†ìŒ)
    â”‚               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â–¶ failed
```

### 6.2 ìƒíƒœ API

**ì—”ë“œí¬ì¸íŠ¸**: `GET /api/collections/[id]/status`

```typescript
// ì‘ë‹µ í˜•ì‹
interface CollectionStatus {
  totalPapers: number; // ì „ì²´ ë…¼ë¬¸ ìˆ˜
  indexedPapers: number; // text_vector_status = 'completed'
  failedPapers: number; // text_vector_status = 'failed'
  downloadingPapers: number; // text_vector_status = 'pending'
  processingPapers: number; // text_vector_status = 'processing'
  allProcessed: boolean; // ëª¨ë“  ë…¼ë¬¸ ì²˜ë¦¬ ì™„ë£Œ ì—¬ë¶€
}
```

**í”„ë¡ íŠ¸ì—”ë“œ í´ë§**:

```typescript
// 500ms ê°„ê²©ìœ¼ë¡œ ìƒíƒœ í´ë§
useEffect(() => {
  const interval = setInterval(async () => {
    const status = await fetchCollectionStatus(collectionId);
    setProgress(status);

    if (status.allProcessed) {
      clearInterval(interval);
    }
  }, 500);

  return () => clearInterval(interval);
}, [collectionId]);
```

### 6.3 ìƒíƒœë³„ UI í‘œì‹œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Collection: Quantum Computing Research                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ğŸ“Š Processing Status                                            â”‚
â”‚                                                                  â”‚
â”‚  Indexed:    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ 35/50 (70%)                   â”‚
â”‚  Processing: â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  7/50 (14%)                   â”‚
â”‚  Pending:    â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  5/50 (10%)                   â”‚
â”‚  Failed:     â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  3/50 (6%)                    â”‚
â”‚                                                                  â”‚
â”‚  âš ï¸ 3 papers failed to process                                  â”‚
â”‚  [Retry Failed] [Upload Manually]                               â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. ì—ëŸ¬ ì²˜ë¦¬ ë° ì¬ì‹œë„

### 7.1 ì—ëŸ¬ ë¶„ë¥˜

#### PDF Download ì—ëŸ¬

| HTTP ìƒíƒœ  | ì—ëŸ¬ ìœ í˜•    | ì¬ì‹œë„ | ì²˜ë¦¬ ë°©ì‹      |
| ---------- | ------------ | ------ | -------------- |
| 404        | Not Found    | âŒ     | ì¦‰ì‹œ ì‹¤íŒ¨ ì²˜ë¦¬ |
| 403        | Forbidden    | âŒ     | ì¦‰ì‹œ ì‹¤íŒ¨ ì²˜ë¦¬ |
| 400        | Bad Request  | âŒ     | ì¦‰ì‹œ ì‹¤íŒ¨ ì²˜ë¦¬ |
| 5xx        | Server Error | âœ…     | 3íšŒ ì¬ì‹œë„     |
| Timeout    | Network      | âœ…     | 3íšŒ ì¬ì‹œë„     |
| ECONNRESET | Connection   | âœ…     | 3íšŒ ì¬ì‹œë„     |

```typescript
// ì¬ì‹œë„ ê°€ëŠ¥í•œ ì—ëŸ¬ì¸ì§€ íŒë‹¨
function isRetryableError(error: AxiosError): boolean {
  if (!error.response) return true; // ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬

  const status = error.response.status;
  return status >= 500 || status === 429; // ì„œë²„ ì—ëŸ¬ ë˜ëŠ” Rate Limit
}
```

#### PDF Indexing ì—ëŸ¬

| ì—ëŸ¬ ìœ í˜•             | ì¬ì‹œë„ | ì²˜ë¦¬ ë°©ì‹                   |
| --------------------- | ------ | --------------------------- |
| Storage ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ | âœ…     | ì¼ì‹œì  ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ        |
| í…ìŠ¤íŠ¸ ì¶”ì¶œ ì‹¤íŒ¨      | âœ…     | PDF ì†ìƒ ê°€ëŠ¥ì„± ë‚®ìŒ        |
| ì„ë² ë”© API ì‹¤íŒ¨       | âœ…     | Rate limit ë˜ëŠ” ì¼ì‹œì  ì˜¤ë¥˜ |
| DB ì‚½ì… ì‹¤íŒ¨          | âŒ     | ìŠ¤í‚¤ë§ˆ ë¬¸ì œ                 |

### 7.2 ì§€ìˆ˜ ë°±ì˜¤í”„

```typescript
// ì¬ì‹œë„ ê°„ê²© ê³„ì‚°
// ì‹œë„ 1: 2ì´ˆ (pdf-download) / 5ì´ˆ (pdf-indexing, figure-analysis)
// ì‹œë„ 2: 4ì´ˆ / 10ì´ˆ
// ì‹œë„ 3: 8ì´ˆ / 20ì´ˆ

backoff: {
  type: 'exponential',
  delay: baseDelay, // 2000 ë˜ëŠ” 5000
}

// ì‹¤ì œ ëŒ€ê¸° ì‹œê°„ = baseDelay Ã— 2^(attempt - 1)
```

### 7.3 ìµœì¢… ì‹¤íŒ¨ ì²˜ë¦¬

```typescript
// Workerì—ì„œ ëª¨ë“  ì¬ì‹œë„ ì‹¤íŒ¨ ì‹œ
try {
  await processJob(job);
} catch (error) {
  if (job.attemptsMade >= job.opts.attempts) {
    // ìµœì¢… ì‹¤íŒ¨ - DB ìƒíƒœ ì—…ë°ì´íŠ¸
    await updatePaperStatus(job.data.paperId, {
      text_vector_status: 'failed',
    });
  }
  throw error; // ì¬ì‹œë„ ë˜ëŠ” ìµœì¢… ì‹¤íŒ¨ ì²˜ë¦¬
}
```

### 7.4 ë…ë¦½ì  ì‹¤íŒ¨ ì²˜ë¦¬

í…ìŠ¤íŠ¸ ì¸ë±ì‹± ì‹¤íŒ¨í•´ë„ Figure ë¶„ì„ì€ ê³„ì† ì§„í–‰:

```
Paper ì²˜ë¦¬ ì‹œë‚˜ë¦¬ì˜¤:

1. í…ìŠ¤íŠ¸ ì„±ê³µ, Figure ì„±ê³µ
   â†’ text_vector_status: 'completed'
   â†’ image_vector_status: 'completed'
   â†’ RAG ì™„ì „ ì§€ì›

2. í…ìŠ¤íŠ¸ ì„±ê³µ, Figure ì‹¤íŒ¨
   â†’ text_vector_status: 'completed'
   â†’ image_vector_status: 'failed'
   â†’ í…ìŠ¤íŠ¸ RAGë§Œ ì§€ì›

3. í…ìŠ¤íŠ¸ ì‹¤íŒ¨, Figure ì„±ê³µ
   â†’ text_vector_status: 'failed'
   â†’ image_vector_status: 'completed'
   â†’ Figure ê²€ìƒ‰ë§Œ ì§€ì› (ì œí•œì )

4. í…ìŠ¤íŠ¸ ì„±ê³µ, Figure ì—†ìŒ
   â†’ text_vector_status: 'completed'
   â†’ image_vector_status: 'skipped'
   â†’ í…ìŠ¤íŠ¸ RAGë§Œ ì§€ì›
```

---

## 8. ì„¤ì • íŒŒë¼ë¯¸í„°

### 8.1 ì²­í‚¹ ì„¤ì •

```typescript
// src/lib/gemini/chunker.ts
const CHUNK_CONFIG = {
  maxCharacters: 3072, // â‰ˆ768 tokens
  overlapCharacters: 450, // ì—°ì†ì„± ìœ ì§€
  minChunkSize: 100, // ìµœì†Œ ì²­í¬ í¬ê¸°
};
```

### 8.2 ì„ë² ë”© ì„¤ì •

```typescript
// src/lib/gemini/embeddings.ts
const EMBEDDING_CONFIG = {
  model: 'embedding-001',
  dimensions: 768,
  batchSize: 100, // API í˜¸ì¶œë‹¹ ì²­í¬ ìˆ˜
};
```

### 8.3 Figure ë¶„ì„ ì„¤ì •

```typescript
// src/lib/jobs/workers/figureAnalysisWorker.ts
const FIGURE_CONFIG = {
  analysisModel: 'gemini-2.5-flash',
  renderDPI: 150,
  batchSize: 10, // ë™ì‹œ ë¶„ì„ Figure ìˆ˜
  rateLimitDelay: 200, // ë°°ì¹˜ ê°„ ë”œë ˆì´ (ms)
};
```

### 8.4 ìŠ¤í† ë¦¬ì§€ ì„¤ì •

```typescript
const STORAGE_CONFIG = {
  bucket: 'pdfs',
  maxFileSize: 100 * 1024 * 1024, // 100MB
  paths: {
    permanent: '/collections/{collectionId}/{paperId}.pdf',
    temporary: '/bulk-temp/{userId}/{sessionId}/{fileId}.pdf',
  },
};
```

### 8.5 ì „ì²´ ì„¤ì • ìš”ì•½

| ì¹´í…Œê³ ë¦¬ | íŒŒë¼ë¯¸í„°          | ê°’     | ì„¤ëª…             |
| -------- | ----------------- | ------ | ---------------- |
| ì²­í‚¹     | maxCharacters     | 3072   | ìµœëŒ€ ì²­í¬ í¬ê¸°   |
| ì²­í‚¹     | overlapCharacters | 450    | ì²­í¬ ê°„ ì˜¤ë²„ë©   |
| ì„ë² ë”©   | dimensions        | 768    | ë²¡í„° ì°¨ì›        |
| ì„ë² ë”©   | batchSize         | 100    | ë°°ì¹˜ë‹¹ ì²­í¬ ìˆ˜   |
| Figure   | batchSize         | 10     | ë™ì‹œ ë¶„ì„ ìˆ˜     |
| Figure   | rateLimitDelay    | 200ms  | ë°°ì¹˜ ê°„ ë”œë ˆì´   |
| ë‹¤ìš´ë¡œë“œ | timeout           | 30ì´ˆ   | ìš”ì²­ íƒ€ì„ì•„ì›ƒ    |
| ë‹¤ìš´ë¡œë“œ | maxSize           | 100MB  | ìµœëŒ€ íŒŒì¼ í¬ê¸°   |
| ì¬ì‹œë„   | attempts          | 3      | ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ |
| ì •ë¦¬     | sessionExpiry     | 24ì‹œê°„ | ì„ì‹œ ì„¸ì…˜ ë§Œë£Œ   |

---

## 9. ëª¨ë‹ˆí„°ë§ ë° ë””ë²„ê¹…

### 9.1 CLI ëª…ë ¹ì–´

```bash
# ì›Œì»¤ ì‹œì‘
npm run workers

# í ìƒíƒœ í™•ì¸
npm run queues:check

# í ì •ë¦¬ (ê°œë°œìš©)
npm run queues:clear
```

### 9.2 ë¡œê·¸ ì¶œë ¥

ê° ì›Œì»¤ëŠ” ìƒì„¸ ë¡œê·¸ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤:

```
[pdf-download] Starting job abc123 for paper xyz789
[pdf-download] Downloading from https://arxiv.org/pdf/...
[pdf-download] Upload complete: /collections/col123/xyz789.pdf
[pdf-download] Job abc123 completed, queuing indexing job

[pdf-indexing] Starting job def456 for paper xyz789
[pdf-indexing] Extracted 15234 characters from 12 pages
[pdf-indexing] Creating 8 chunks with embeddings
[pdf-indexing] Progress: 30%
[pdf-indexing] Progress: 60%
[pdf-indexing] Progress: 90%
[pdf-indexing] Inserted 8 chunks to pgvector
[pdf-indexing] Job def456 completed, queuing figure analysis

[figure-analysis] Starting job ghi789 for paper xyz789
[figure-analysis] Detected 5 figures
[figure-analysis] Analyzing batch 1/1 (5 figures)
[figure-analysis] Indexed 5 figures to pgvector
[figure-analysis] Job ghi789 completed
```

### 9.3 Redis ëª¨ë‹ˆí„°ë§

```bash
# Redis CLIë¡œ í ìƒíƒœ í™•ì¸
redis-cli

# ëŒ€ê¸° ì¤‘ì¸ ì‘ì—… ìˆ˜
LLEN bull:pdf-download:wait
LLEN bull:pdf-indexing:wait
LLEN bull:figure-analysis:wait

# ì²˜ë¦¬ ì¤‘ì¸ ì‘ì—…
LLEN bull:pdf-download:active
LLEN bull:pdf-indexing:active

# ì‹¤íŒ¨í•œ ì‘ì—…
LLEN bull:pdf-download:failed
LLEN bull:pdf-indexing:failed
```

### 9.4 ë””ë²„ê¹… ì²´í¬ë¦¬ìŠ¤íŠ¸

**ì‘ì—…ì´ ì²˜ë¦¬ë˜ì§€ ì•Šì„ ë•Œ**:

1. âœ… Workers ì‹¤í–‰ ì¤‘ì¸ê°€? (`npm run workers`)
2. âœ… Redis ì—°ê²° í™•ì¸ (`npm run queues:check`)
3. âœ… íì— ì‘ì—…ì´ ìˆëŠ”ê°€? (Redis í™•ì¸)
4. âœ… Worker ë¡œê·¸ì— ì—ëŸ¬ê°€ ìˆëŠ”ê°€?

**ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ ì‹œ**:

1. âœ… PDF URLì´ ìœ íš¨í•œê°€?
2. âœ… Open Access ë…¼ë¬¸ì¸ê°€?
3. âœ… ë„¤íŠ¸ì›Œí¬ ì—°ê²° ìƒíƒœ
4. âœ… ì—ëŸ¬ ë¡œê·¸ í™•ì¸ (403/404/timeout)

**ì¸ë±ì‹± ì‹¤íŒ¨ ì‹œ**:

1. âœ… PDFê°€ Storageì— ìˆëŠ”ê°€?
2. âœ… PDFê°€ ì†ìƒë˜ì§€ ì•Šì•˜ëŠ”ê°€?
3. âœ… Gemini API í‚¤ ìœ íš¨í•œê°€?
4. âœ… Rate limit ë„ë‹¬í–ˆëŠ”ê°€?

---

## ì°¸ì¡° íŒŒì¼

| íŒŒì¼                                                         | ì„¤ëª…                |
| ------------------------------------------------------------ | ------------------- |
| `src/lib/jobs/queues.ts`                                     | í ì •ì˜ ë° Job íƒ€ì… |
| `src/lib/jobs/workers/pdfDownloadWorker.ts`                  | PDF ë‹¤ìš´ë¡œë“œ ì›Œì»¤   |
| `src/lib/jobs/workers/pdfIndexWorker.ts`                     | í…ìŠ¤íŠ¸ ì¸ë±ì‹± ì›Œì»¤  |
| `src/lib/jobs/workers/figureAnalysisWorker.ts`               | Figure ë¶„ì„ ì›Œì»¤    |
| `src/lib/jobs/workers/bulkUploadCleanupWorker.ts`            | ì •ë¦¬ ì›Œì»¤           |
| `src/app/api/collections/route.ts`                           | Collection ìƒì„± API |
| `src/app/api/collections/[id]/status/route.ts`               | ìƒíƒœ ì¡°íšŒ API       |
| `src/lib/db/chunks.ts`                                       | ì²­í¬ ì €ì¥ ë¡œì§      |
| `src/lib/gemini/embeddings.ts`                               | ì„ë² ë”© ìƒì„±         |
| `supabase/migrations/20251214120000_split_vector_status.sql` | ìƒíƒœ ìŠ¤í‚¤ë§ˆ         |
